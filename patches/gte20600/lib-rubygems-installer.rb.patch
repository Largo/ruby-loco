Patch by MSP-Greg
diff --git a/lib/rubygems/installer.rb b/lib/rubygems/installer.rb
index 657f21296f..3df95c7728 100644
--- a/lib/rubygems/installer.rb
+++ b/lib/rubygems/installer.rb
@@ -771,16 +771,19 @@ def app_script_text(bin_file_name)
   # return the stub script text used to launch the true Ruby script
 
   def windows_stub_script(bindir, bin_file_name)
-    rb_bindir = RbConfig::CONFIG["bindir"]
-    # All comparisons should be case insensitive
-    if bindir.downcase == rb_bindir.downcase
+    rb_bindir = (RbConfig::TOPDIR || File.dirname(RbConfig::CONFIG["bindir"])).downcase
+    ruby_exe = "#{RbConfig::CONFIG['RUBY_INSTALL_NAME']}#{RbConfig::CONFIG['EXEEXT']}"
+    ruby_exe = ruby_exe == '' ? 'ruby.exe' : ruby_exe
+
+    # check whether ruby executable exists in bindir
+    if File.exist?(File.join bindir, ruby_exe)
       # stub & ruby.exe withing same folder.  Portable
       <<-TEXT
 @ECHO OFF
 @"%~dp0ruby.exe" "%~dpn0" %*
       TEXT
-    elsif bindir.downcase.start_with? (RbConfig::TOPDIR || File.dirname(rb_bindir)).downcase
-      # stub within ruby folder, but not standard bin.  Not portable
+    elsif bindir.downcase.start_with? rb_bindir
+      # stub within ruby folder, but not standard bin.  Portable
       require 'pathname'
       from = Pathname.new bindir
       to   = Pathname.new rb_bindir
@@ -790,7 +793,8 @@ def windows_stub_script(bindir, bin_file_name)
 @"%~dp0#{rel}/ruby.exe" "%~dpn0" %*
       TEXT
     else
-      # outside ruby folder, maybe -user-install or bundler.  Portable
+      # outside ruby folder, maybe -user-install or bundler.  Portable, but ruby
+      # is dependent on PATH
       <<-TEXT
 @ECHO OFF
 @ruby.exe "%~dpn0" %*
