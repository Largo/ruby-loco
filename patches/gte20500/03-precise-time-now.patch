Patch by kubo (Takehiro Kubo)
See https://bugs.ruby-lang.org/issues/13732
diff --git a/win32/win32.c b/win32/win32.c
index c7204bc6a7..cc117cd682 100644
--- a/win32/win32.c
+++ b/win32/win32.c
@@ -4576,13 +4576,28 @@ filetime_to_timeval(const FILETIME* ft, struct timeval *tv)
     return tv->tv_sec > 0 ? 0 : -1;
 }
 
+static void get_filetime(FILETIME *ft)
+{
+    typedef void (WINAPI *get_time_func)(FILETIME *ft);
+    static get_time_func func = (get_time_func)-1;
+
+    if (func == (get_time_func)-1) {
+	/* GetSystemTimePreciseAsFileTime is available since Windows 8 and Windows Server 2012. */
+	func = (get_time_func)get_proc_address("kernel32", "GetSystemTimePreciseAsFileTime", NULL);
+	if (func == NULL) {
+	    func = GetSystemTimeAsFileTime;
+	}
+    }
+    func(ft);
+}
+
 /* License: Ruby's */
 int __cdecl
 gettimeofday(struct timeval *tv, struct timezone *tz)
 {
     FILETIME ft;
 
-    GetSystemTimeAsFileTime(&ft);
+    get_filetime(&ft);
     filetime_to_timeval(&ft, tv);
 
     return 0;
@@ -7340,7 +7355,7 @@ wutimensat(int dirfd, const WCHAR *path, const struct timespec *times, int flags
 	}
     }
     else {
-	GetSystemTimeAsFileTime(&atime);
+	get_filetime(&atime);
 	mtime = atime;
     }
 
